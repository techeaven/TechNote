---
title: SSH端口转发
categories: D-Linux
permalink: sh-port-forwarding
translate_title: ssh-port-forwarding
date: 2015-12-16 11:20:34
tags:
description:
---
## 概述
在一些安全性较高的网络环境中，通常两个网络之间的互联会做各种各样的限制。比如最近遇到的一些情况是，客户的网络中有三台主机，但是只有一台主机开放了22端口，用户ssh登录部署代码，但是部署代码之后，并不能访问相关的代码。在这种情况下，公司的一位同事给出了使用ssh端口转发的方案。   

在了解了ssh端口并使用了几次之后，决定写篇文章记录下。 


## 端口转发类型
ssh端口转发可以分为三种：
* 本地(正向)端口转发
* 远程(反向)端口转发
* 动态端口转发


为了更清晰的说明这几种端口转发方式，先假设有两个不同的局域网:Company和Customer（其中Company表示个人公司局域网，Customer表示客户所在的局域网）。  
Company局域网中存在主机:
* 10.0.250.141(A)
* 10.0.250.7(B)

Customer局域网中存在主机:
* 192.16.6.80(C)
* 192.16.6.81(D)

其中只有主机A能访问主机C的22端口，其他的所有访问都被网络规则禁止。
> 有一点需要注意的是，主机C其实是有一个公网IP的，这里仅仅为了方便文章说明，所以使用了内网IP。


## 本地端口转发
现在假设主机D上装有web服务，监听的端口是8080，现在要通过主机A访问主机D的Web服务，就要使用正向端口转发。要使用ssh的正向端口转发很简单，只需使用如下命令:
```
ssh -Nf -L 8877:192.16.6.81:8000 user@192.16.6.80
```
参数说明：
* -L 表示将本地的887端口，转发到远程主机192.16.6.81的8000端口
* -N 不执行远程的命令
* -f 后台认证用户/密码，通常和-N连用，不用登录到远程主机。

## 远程端口转发
现在假设要从主机D访问主机A，这样就需要用到远程端口转发了。使用远程端口转发，同样只需要一条命令:
```
ssh -Nf -R 8888:10.0.250.141:22 user@192.16.6.80
```
* -R 表示将远程的8888端口转发到本地的22端口

## 动态端口转发
动态端口转发相对于本地端口转发和远程端口转发会简单点，可以使用如下命令:
```
ssh -D 8888 user@192.16.6.80
```
动态端口转发实际上是建立一个ssh加密的SOCKS4/5代理通道，任何支持SOCKS4/5协议的程序都可以使用这个加密的通道来进行代理访问。  

该方法也是一种翻墙的方法。

## 总结
端口转发在某些特定场景下是非常有用的，不过因为没有试验远程端口转发的环境，所以远程端口转发的效果并没有体验到。  

## 参考
* [http://www.cnblogs.com/itech/archive/2013/02/28/2937882.html](http://www.cnblogs.com/itech/archive/2013/02/28/2937882.html)
* [http://netsecurity.51cto.com/art/201304/390460.htm](http://netsecurity.51cto.com/art/201304/390460.htm)
<br />