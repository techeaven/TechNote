---
title: MySQL慢查询日志
categories: B-MySQL优化
permalink: mysql-slow-query-log
translate_title: mysql-slow-query-log
date: 2015-07-22 17:14:45
tags:
description:
---
## 概述
MySQL优化中，最重要的一项应该就是对慢查询的处理，慢查询一般记录在慢查询日志中（需要修改配置文件）。

## 开启慢查询
开启MySQL慢查询日志的方法很简单，只要修改在MySQL配置文件中，增加慢查询相关的配置项即可，配置如下：
```
# 慢查询日志文件位置
log_slow_queries        = /var/log/mysql/mysql-slow.log
# 慢查询的执行时间下限，可以为小数，一般为2或3
long_query_time = 0.1
# 没有使用索引的查询也一并记录
log-queries-not-using-indexes
```
修改完配置文件后，重启MySQL服务即可。除了通过配置文件，也可以通过`命令行`的方式开启慢查询。

## 慢查询日志记录分析
### 产生一条慢查询日志
如果手头没有数据，我们可以构造一条慢查询出来，查询如下:
```
select sleep(5);
```
执行完上面的一条语句后，就会产生一条慢查询日志：
```
# Time: 150723  1:31:52                                                                        
# User@Host: root[root] @ localhost []                                                         
# Query_time: 3.002055  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0                     
SET timestamp=1437586312;                                                                      
select sleep(3);
```
每一条慢查询日志都是类似于上面的格式。
<br />
### 慢查询日志内容分析
(1) `Time: 150723  1:31:52 `  
这一行表示的是慢查询日志被记录的时间。格式为:`YYMMDD H:i:s`,从上面的日志可以看出，这条慢查询是在2015年7月23日 1:31:52产生的。  

(2) `# User@Host: root[root] @ localhost []`  
这一行表示连接MySQL的用户名以及主机  

(3) `# Query_time: 3.002055  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0`  
这一行表示的是查询耗费的总时间(Query_time)、锁时间(Lock_time)、返回的记录数目(Rows_sent)、查询过程中所检测的行数(Rows_examined)。  

(4) `SET timestamp=1437586312;`  
这一行表示的是`查询真正开始的时间`。可以通过Linux命令将改时间转换为可读的时间`date -d @1437586312`。这一行对于排错也是非常有用的。在这个实例中，查询开始的时间和日志被记录的时间是一致的，但是在高负载的服务器下，这两个时间通常是不一样的。

(5) `select sleep(3);`  
执行的SQL语句。  


## Query_time、Lock_time的含义
### Lock_time
查询语句开始执行之前耗费的时间。比如，等待其他线程释放当前查询语句所需要的锁（不太理解，暂且记录下来）。
<br />
### Query_time
查询语句的执行时间。如果查询的记录不在缓冲池中，这个时间可能包含等待磁盘I/O的时间。在数据被加载到缓冲池以后，重复执行该语句，肯能会快很多。  

如果所执行的查询在磁盘上有序，即使查询所要遍历的记录较少，查询也可能很慢。  

如果I/O系统超负荷，可能会得到一些间断的延时。这种情况在虚拟I/O系统中也可能发生，比如阿里云。对于这种情况，可以使用`iostat`命令查看队列长度、等待时间和提供服务的时间。

## 总结
之前看过好多关于MySQL优化的文章，一直没有实践的机会，现在开始实践了。还是有很多不清楚的地方，慢慢的这部分知识补齐来。

## 参考
* [How to interpret slow query log information generated by MySQL?](http://stackoverflow.com/questions/19036176/how-to-interpret-slow-query-log-information-generated-by-mysql)
<br />
